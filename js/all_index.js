class DBHelper{static get DATABASE_URL(){return"http://localhost:1337/restaurants"}static get dB(){return DBHelper._dB?Promise.resolve(DBHelper._dB):new Promise((e,t)=>{const r=indexedDB.open("restaurant-reviews",1);r.onerror=(()=>t()),r.onupgradeneeded=(()=>{const e=r.result.createObjectStore("restaurants",{keyPath:"id"});e.createIndex("id","id"),e.createIndex("cuisine","cuisine_type"),e.createIndex("neighborhood","neighborhood")}),r.onsuccess=(t=>{DBHelper._dB=r.result,console.log("ok here"),e(DBHelper._dB)})})}static putRestaurantsInDb(e){return DBHelper.dB.then(t=>{const r=t.transaction("restaurants","readwrite").objectStore("restaurants");e.forEach(e=>{r.put({id:e.id,restaurant:e})})}).catch(()=>{console.log(`Whoops! Couldn't set data: ${e}`)})}static getRestaurantsFromDb(e){return DBHelper.dB.then(t=>{const r=t.transaction("restaurants","readonly").objectStore("restaurants");return e?r.getAll(e):r.getAll()}).catch(()=>{console.log(`Whoops! Couldn't return data for restaurant ${e}`)})}static fetchRestaurants(e,t=""){let r=e;DBHelper.getRestaurantsFromDb(t).then(e=>{e&&e.length>0&&(r(null,e),r=(()=>{}))}).then(()=>fetch(`${DBHelper.DATABASE_URL}/${t}`)).then(e=>e.json()).then(e=>{DBHelper.putRestaurantsInDb(e),r(null,e)}).catch(e=>{r(`Whoops! ${e.message}`,null)})}static fetchRestaurantById(e,t){DBHelper.fetchRestaurants((r,n)=>{if(r)t(r,null);else{const r=n.find(t=>t.id==e);r?t(null,r):t("Restaurant does not exist",null)}},e)}static fetchRestaurantByCuisine(e,t){DBHelper.fetchRestaurants((e,r)=>{if(e)t(e,null);else{const e=r.find(e=>e.id==id);e?t(null,e):t("Restaurant does not exist",null)}},id)}static fetchRestaurantByNeighborhood(e,t){DBHelper.fetchRestaurants((r,n)=>{if(r)t(r,null);else{const r=n.filter(t=>t.neighborhood==e);t(null,r)}})}static fetchRestaurantByCuisineAndNeighborhood(e,t,r){DBHelper.fetchRestaurants((n,s)=>{if(n)r(n,null);else{let n=s;"all"!=e&&(n=n.filter(t=>t.cuisine_type==e)),"all"!=t&&(n=n.filter(e=>e.neighborhood==t)),r(null,n)}})}static fetchNeighborhoods(e){DBHelper.fetchRestaurants((t,r)=>{if(t)e(t,null);else{const t=r.map((e,t)=>r[t].neighborhood),n=t.filter((e,r)=>t.indexOf(e)==r);e(null,n)}})}static fetchCuisines(e){DBHelper.fetchRestaurants((t,r)=>{if(t)e(t,null);else{const t=r.map((e,t)=>r[t].cuisine_type),n=t.filter((e,r)=>t.indexOf(e)==r);e(null,n)}})}static urlForRestaurant(e){return`./restaurant.html?id=${e.id}`}static imageUrlForRestaurant(e,t=""){return`/img/${e.id}${t}.webp`}static mapMarkerForRestaurant(e,t){return new google.maps.Marker({position:e.latlng,title:e.name,url:DBHelper.urlForRestaurant(e),map:t,animation:google.maps.Animation.DROP})}}
"serviceWorker"in navigator&&window.addEventListener("load",function(){navigator.serviceWorker.register("sw.js").then(function(e){console.log("ServiceWorker registration successful with scope: ",e.scope)},function(e){console.log("ServiceWorker registration failed: ",e)})});
let restaurants,neighborhoods,cuisines,map,markers=[];document.addEventListener("DOMContentLoaded",e=>{DBHelper.dB.then(()=>{DBHelper.fetchRestaurants((e,t)=>{e?console.error(e):(self.restaurants=t,fillRestaurantsHTML()),fetchNeighborhoods(),fetchCuisines(),addMarkersToMap()})})}),fetchNeighborhoods=(()=>{DBHelper.fetchNeighborhoods((e,t)=>{e?console.error(e):(self.neighborhoods=t,fillNeighborhoodsHTML())})}),fillNeighborhoodsHTML=((e=self.neighborhoods)=>{const t=document.getElementById("neighborhoods-select");e.forEach(e=>{const s=document.createElement("option");s.innerHTML=e,s.value=e,t.append(s)})}),fetchCuisines=(()=>{DBHelper.fetchCuisines((e,t)=>{e?console.error(e):(self.cuisines=t,fillCuisinesHTML())})}),fillCuisinesHTML=((e=self.cuisines)=>{const t=document.getElementById("cuisines-select");e.forEach(e=>{const s=document.createElement("option");s.innerHTML=e,s.value=e,t.append(s)})}),window.initMap=(()=>{let e={lat:40.722216,lng:-73.987501};try{self.map=new google.maps.Map(document.getElementById("map"),{zoom:12,center:e,scrollwheel:!1})}catch(e){}}),updateRestaurants=(()=>{const e=document.getElementById("cuisines-select"),t=document.getElementById("neighborhoods-select"),s=e.selectedIndex,n=t.selectedIndex,a=e[s].value,r=t[n].value;DBHelper.fetchRestaurantByCuisineAndNeighborhood(a,r,(e,t)=>{e?console.error(e):(resetRestaurants(t),fillRestaurantsHTML())})}),resetRestaurants=(e=>{self.restaurants=[],document.getElementById("restaurants-list").innerHTML="",self.markers&&self.markers.forEach(e=>e.setMap(null)),self.markers=[],self.restaurants=e}),fillRestaurantsHTML=((e=self.restaurants)=>{const t=document.getElementById("restaurants-list");e.forEach(e=>{t.append(createRestaurantHTML(e))}),addMarkersToMap()}),createRestaurantHTML=(e=>{const t=document.createElement("li");t.className="list-restaurant-container column";const s=document.createElement("img");s.alt=`${e.name} - ${e.neighborhood}`,s.className="list-restaurant-img lazy",s.src="data:image/png;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=",s.setAttribute("data-src",DBHelper.imageUrlForRestaurant(e,"-sm")),t.append(s);const n=document.createElement("h1");n.className="list-restaurant-name",n.innerHTML=e.name,t.append(n);const a=document.createElement("p");a.className="list-restaurant-neighborhood",a.innerHTML=e.neighborhood,t.append(a);const r=document.createElement("p");r.className="list-restaurant-address",r.innerHTML=e.address,t.append(r);const o=document.createElement("a");return o.className="list-restaurant-more",o.innerHTML="View Details",o.href=DBHelper.urlForRestaurant(e),t.append(o),t}),addMarkersToMap=((e=window.restaurants)=>{e.forEach(e=>{const t=DBHelper.mapMarkerForRestaurant(e,window.map);google.maps.event.addListener(t,"click",()=>{window.location.href=t.url}),markers.push(t)})});
